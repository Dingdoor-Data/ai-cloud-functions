name: Deploy Cloud Functions (v2)

on:
  push:
    branches: [ master, development ]
  workflow_dispatch: {}

permissions:
  contents: read

env:
  REGION: us-central1
  PROJECT_ID: ${{ github.ref_name == 'master' && secrets.GCP_PROJECT_PROD || secrets.GCP_PROJECT_DEV }}
  CREDS_JSON: ${{ github.ref_name == 'master' && secrets.GOOGLE_CREDENTIALS_PROD || secrets.GOOGLE_CREDENTIALS_DEV }}

jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      dirs: ${{ steps.find.outputs.dirs }}
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq
      - id: find
        name: Select functions to deploy
        shell: bash
        run: |
          set -euo pipefail

          BASE="${{ github.event.before }}"
          HEAD="${{ github.sha }}"

          if ! git cat-file -e "$BASE^{commit}" 2>/dev/null; then
            echo "BASE sha not found (likely force-push). Falling back to HEAD^."
            BASE="$(git rev-parse "$HEAD^" 2>/dev/null || true)"
          fi

          if [ -z "${BASE:-}" ]; then
            BASE="$HEAD"
          fi

          git diff --name-only "$BASE" "$HEAD" \
            | awk -F/ '/^functions\/[^/]+\//{print $1"/"$2}' \
            | sort -u > changed.txt

          jq -Rsc 'split("\n")|map(select(length>0))' changed.txt > dirs.json
          echo "dirs=$(cat dirs.json)" >> "$GITHUB_OUTPUT"

  deploy:
    needs: detect
    if: ${{ needs.detect.outputs.dirs != '[]' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        dir: ${{ fromJSON(needs.detect.outputs.dirs) }}
    steps:
      - uses: actions/checkout@v4
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # Auth with Service Account JSON (per-branch)
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ env.CREDS_JSON }}

      - uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Deploy ${{ matrix.dir }} with gcloud functions (Gen2)
        shell: bash
        env:
          REGION: ${{ env.REGION }}
          PROJECT_ID: ${{ env.PROJECT_ID }}
        run: |
          set -euo pipefail
          DIR="${{ matrix.dir }}"
          BRANCH="${{ github.ref_name }}"
          NAME=$(jq -r .name "$DIR/function.json")
          ENTRY=$(jq -r .entrypoint "$DIR/function.json")
          RUNTIME=$(jq -r .runtime "$DIR/function.json")   # e.g. "python312"
          TRIGGER=$(jq -r .trigger "$DIR/function.json")
          AUTH=$(jq -r .allow_unauthenticated "$DIR/function.json")
          
          ENV_FILE="$DIR/env.dev.yaml"
          if [ "$BRANCH" = "master" ]; then
            ENV_FILE="$DIR/env.prod.yaml"
          fi

          if [ ! -f "$ENV_FILE" ]; then
            echo "Missing env file: $ENV_FILE" >&2
            exit 1
          fi

          if [ "$TRIGGER" = "http" ]; then
            UA=""
            [ "$AUTH" = "true" ] && UA="--allow-unauthenticated"

            gcloud functions deploy "$NAME" \
              --gen2 \
              --project "$PROJECT_ID" \
              --region "$REGION" \
              --runtime "$RUNTIME" \
              --source "$DIR" \
              --entry-point "$ENTRY" \
              --trigger-http \
              $UA \
              --env-vars-file "$ENV_FILE"

            URL=$(gcloud functions describe "$NAME" --gen2 --region "$REGION" \
              --format='value(serviceConfig.uri)')
            echo "### $NAME URL" >> $GITHUB_STEP_SUMMARY
            echo "$URL" >> $GITHUB_STEP_SUMMARY

          elif [ "$TRIGGER" = "firestore" ]; then
            DB=$(jq -r '.event_filters.database' "$DIR/function.json")
            PATTERN=$(jq -r '.path_pattern' "$DIR/function.json")

            gcloud functions deploy "$NAME" \
              --gen2 \
              --project "$PROJECT_ID" \
              --region "$REGION" \
              --runtime "$RUNTIME" \
              --source "$DIR" \
              --entry-point "$ENTRY" \
              --trigger-event-filters=type=google.cloud.firestore.document.v1.written \
              --trigger-event-filters=database="$DB" \
              --trigger-event-filters-path-pattern=document="$PATTERN" \
              --env-vars-file "$ENV_FILE"
          else
            echo "Unknown trigger in $DIR/function.json" >&2
            exit 1
          fi
