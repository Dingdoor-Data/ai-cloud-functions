name: Deploy Cloud Run functions

on:
  push:
    branches: [ master, development ]
  workflow_dispatch: {}

permissions:
  contents: read

env:
  REGION: us-central1
  PROJECT_ID: ${{ github.ref_name == 'master' && secrets.GCP_PROJECT_PROD || secrets.GCP_PROJECT_DEV }}
  CREDS_JSON: ${{ github.ref_name == 'master' && secrets.GOOGLE_CREDENTIALS_PROD || secrets.GOOGLE_CREDENTIALS_DEV }}


jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      dirs: ${{ steps.find.outputs.dirs }}
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq
      - id: find
        name: Select functions to deploy
        shell: bash
        run: |
          BRANCH="${{ github.ref_name }}"
          if [ "$BRANCH" = "development" ]; then
            find functions -mindepth 1 -maxdepth 1 -type d -print > changed.txt
          else
            BASE="${{ github.event.before }}"
            if [ -z "$BASE" ] || [ "$BASE" = "0000000000000000000000000000000000000000" ]; then
              BASE="$(git rev-parse HEAD^ || true)"
            fi
            HEAD="${{ github.sha }}"
            git diff --name-only "$BASE" "$HEAD" \
              | awk -F/ '/^functions\/[^/]+\//{print $1"/"$2}' \
              | sort -u > changed.txt
          fi
          jq -Rsc 'split("\n")|map(select(length>0))' changed.txt > dirs.json
          echo "dirs=$(cat dirs.json)" >> "$GITHUB_OUTPUT"

  deploy:
    needs: detect
    if: ${{ needs.detect.outputs.dirs != '[]' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      # id-token is NOT required when using key JSON
    strategy:
      fail-fast: false
      matrix:
        dir: ${{ fromJSON(needs.detect.outputs.dirs) }}
    env:
      PROJECT_ID: ${{ github.ref_name == 'master' && secrets.GCP_PROJECT_PROD || secrets.GCP_PROJECT_DEV }}
    steps:
      - uses: actions/checkout@v4
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # üîÅ Auth with Service Account Key JSON (replaces WIF)
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ env.CREDS_JSON }}   # <- your key

      - uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Deploy ${{ matrix.dir }}
        shell: bash
        run: |
          set -euo pipefail
          DIR="${{ matrix.dir }}"
          NAME=$(jq -r .name "$DIR/function.json")
          ENTRY=$(jq -r .entrypoint "$DIR/function.json")
          REGION="${{ env.REGION }}"
          BASE=$(jq -r .base_image "$DIR/function.json")
          TRIGGER=$(jq -r .trigger "$DIR/function.json")
          AUTH=$(jq -r .allow_unauthenticated "$DIR/function.json")

          if [ "$TRIGGER" = "http" ]; then
            UA_FLAG="--no-allow-unauthenticated"
            [ "$AUTH" = "true" ] && UA_FLAG="--allow-unauthenticated"
            gcloud run deploy "$NAME" \
              --project "${{ env.PROJECT_ID }}" \
              --region "$REGION" \
              --source "$DIR" \
              --function "$ENTRY" \
              --base-image "$BASE" \
              $UA_FLAG

            URL=$(gcloud run services describe "$NAME" \
              --project "${{ env.PROJECT_ID }}" --region "$REGION" \
              --format='value(status.url)')
            echo "### $NAME URL" >> $GITHUB_STEP_SUMMARY
            echo "$URL" >> $GITHUB_STEP_SUMMARY

          elif [ "$TRIGGER" = "firestore" ]; then
            gcloud run deploy "$NAME" \
              --project "${{ env.PROJECT_ID }}" \
              --region "$REGION" \
              --source "$DIR" \
              --function "$ENTRY" \
              --base-image "$BASE"

            DB=$(jq -r '.event_filters.database' "$DIR/function.json")
            PATTERN=$(jq -r '.path_pattern' "$DIR/function.json")
            TRIGGER_NAME="${NAME}-trigger"

            gcloud eventarc triggers delete "$TRIGGER_NAME" --location="$REGION" --quiet || true
            gcloud eventarc triggers create "$TRIGGER_NAME" \
              --location="$REGION" \
              --destination-run-service="$NAME" \
              --destination-run-region="$REGION" \
              --event-filters=type=google.cloud.firestore.document.v1.written \
              --event-filters=database="$DB" \
              --event-data-content-type=application/protobuf \
              --event-filters-path-pattern=document="$PATTERN"
          else
            echo "Unknown trigger in $DIR/function.json" >&2
            exit 1
          fi
